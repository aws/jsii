dist: xenial
language: generic
jdk: openjdk8
node_js: 8
rvm: 2.4

branches:
  only:
    - master
    - /v\d+\.\d+.\d+/

services:
  - docker

before_install:
  - wget -q https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
  - sudo dpkg -i packages-microsoft-prod.deb
  - sudo apt-get install apt-transport-https
  - sudo apt-get update
  - sudo apt-get install dotnet-sdk-2.2

jobs:
  include:
    - stage: build
      name: NPM Packages
      script: ./install.sh && ./build.sh
    - stage: build
      name: Docker Image
      script: >-
        docker build --build-arg BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')     \
                    --build-arg COMMIT_ID="${TRAVIS_COMMIT}"                         \
                    -t "${DOCKER_USERNAME}/superchain:latest"                        \
                    ./superchain
    - stage: publish
      name: Docker Image
      # If a tag build, update jsii/superchain:latest, otherwise, update jsii/superchain:<branch-name>
      script: >-
        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
        && if [ ! -z "${TRAVIS_TAG+SET}" ]; then
            docker push "${DOCKER_USERNAME}/superchain:latest"
          else
            docker push "${DOCKER_USERNAME}/superchain:${TRAVIS_BRANCH}"
          fi

stages:
  - build
  - name: publish
    if: ((branch = master) OR (branch =~ /^v\d+\.\d+.\d+$/)) AND env(DOCKER_USERNAME) IS present AND env(DOCKER_PASSWORD) IS present
