language: minimal

branches:
  only:
    - master
    - /v\d+\.\d+.\d+/

services:
  - docker

before_script:
  # Attempt to pre-cache the previous version of the image, to speed build up
  - docker pull jsii/superchain:latest || true

script:
  - set -eo pipefail
  - docker build --pull --build-arg BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ') --build-arg COMMIT_ID="${TRAVIS_COMMIT}" -t "jsii/superchain:latest" ./superchain
  - docker run --rm -it --net=host -v ${PWD}:${PWD} -w ${PWD} jsii/superchain:latest ./build.sh
  - echo "TRAVIS_PULL_REQUEST = ${TRAVIS_PULL_REQUEST:-}"
  - echo "TRAVIS_TAG          = ${TRAVIS_TAG:-}"
  - echo "TRAVIS_BRANCH       = ${TRAVIS_BRANCH:-}"
  - >-
    if [ ${TRAVIS_PULL_REQUEST} = false ] && [ ! -z "${DOCKER_USERNAME+SET}" ] && [ ! -z "${DOCKER_PASSWORD+SET}" ]; then
      echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
      docker tag "jsii/superchain:latest" "jsii/superchain:${TRAVIS_BRANCH}"
      docker push "jsii/superchain:${TRAVIS_BRANCH}"
      if [ "${TRAVIS_TAG:-}" = "${TRAVIS_BRANCH}" ]; then
        docker push jsii/superchain:latest
      fi
    fi
