language: minimal

branches:
  only:
    - master
    - /v\d+\.\d+.\d+/

services:
  - docker

script:
  - docker build --build-arg BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ') --build-arg COMMIT_ID="${TRAVIS_COMMIT}" -t "jsii/superchain:latest" ./superchain
  - docker run --rm -it --net=host -v ${PWD}:${PWD} -w ${PWD} jsii/superchain:latest ./build.sh
  - >-
      if [ \( ! -z "${DOCKER_USERNAME+SET}" \) -a \( ! -z "${DOCKER_PASSWORD+SET}" \) ]; then
        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin        && \
        if [ ! -z "${TRAVIS_TAG+SET}" ]; then
          docker push jsii/superchain:latest
        else
          docker push "jsii/superchain:${TRAVIS_BRANCH}"
        fi
      fi

jobs:
  include:
    - stage: npm
      name: NPM Packages
      script: ./install.sh && ./build.sh
    - stage: docker
      name: Docker Image
      # If a tag build, update jsii/superchain:latest, otherwise, update jsii/superchain:<branch-name>
      script: >-
        docker build --build-arg BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')                   \
                     --build-arg COMMIT_ID="${TRAVIS_COMMIT}"                                       \
                     -t "jsii/superchain:latest"                                                    \
                     ./superchain
        && if [ ! -z "${DOCKER_USERNAME+SET}" ] && [ ! -z "${DOCKER_PASSWORD+SET}" ]; then
          echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          && if [ ! -z "${TRAVIS_TAG+SET}" ]; then
              docker push "jsii/superchain:latest"
            else
              docker push "jsii/superchain:${TRAVIS_BRANCH}"
            fi
          fi

stages:
  - npm
  - docker
