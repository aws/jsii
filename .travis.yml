dist: xenial
language: generic
jdk: openjdk8
node_js: 8
rvm: 2.4

env:
  global:
    DOTNET_CLI_TELEMETRY_OPTOUT: 1
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
    JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64

branches:
  only:
    - master
    - /v\d+\.\d+.\d+/

services:
  - docker

before_install:
  - wget -q https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
  - sudo dpkg -i packages-microsoft-prod.deb
  - sudo apt-get install apt-transport-https
  - sudo apt-get update
  - sudo apt-get install dotnet-sdk-2.2 python3-venv python3-setuptools python3-venv python3-wheel
  - sudo update-java-alternatives --set java-1.8.0-openjdk-amd64
  - gem install bundler
  - pyenv install 3.6.9

jobs:
  include:
    - stage: build
      name: NPM Packages
      script: ./install.sh && ./build.sh
    - stage: publish
      name: Docker Image
      # If a tag build, update jsii/superchain:latest, otherwise, update jsii/superchain:<branch-name>
      script: >-
        docker build --build-arg BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')     \
                    --build-arg COMMIT_ID="${TRAVIS_COMMIT}"                         \
                    -t "jsii/superchain:latest"                        \
                    ./superchain
        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
        && if [ ! -z "${TRAVIS_TAG+SET}" ]; then
            docker push "jsii/superchain:latest"
          else
            docker push "jsii/superchain:${TRAVIS_BRANCH}"
          fi

stages:
  - build
  - name: publish
    if: ((branch = master) OR (branch =~ /^v\d+\.\d+.\d+$/)) AND env(DOCKER_USERNAME) IS present AND env(DOCKER_PASSWORD) IS present
