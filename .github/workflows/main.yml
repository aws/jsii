# Workflows pertaining to the main/master branch
name: Main

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

env:
  DOTNET_NOLOGO: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Set up .NET 3.1
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.x'
      - name: Set up Java 8
        uses: actions/setup-java@v1
        with:
          java-version: '8'
      - name: Set up Node 12
        uses: actions/setup-node@v2.1.1
        with:
          node-version: '12'
      - name: Set up Python 3.6
        uses: actions/setup-node@v2.1.1
        with:
          python-version: '3.6'
      - name: Install python3-venv
        if: runner.os == 'Linux'
        run: sudo apt install -y python3-venv
      - name: Check out
        uses: actions/checkout@v2
      - name: Locate Caches
        id: cache-locations
        run: |-
          # Need to have PIP >= 20.1 for "pip cache dir" to work
          python -m pip install --upgrade pip
          echo "::set-output name=pip-cache::$(pip cache dir)"
          echo "::set-output name=yarn-cache::$(yarn cache dir)"
      - name: Cache
        uses: actions/cache@v2
        with:
          path: |-
            ${{ steps.cache-locations.outputs.pip-cache }}
            ${{ steps.cache-locations.outputs.yarn-cache }}
            ~/.m2/repository
            ~/.nuget/packages
          key: ${{ runner.os }}-node@12-python@3.6-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |-
            ${{ runner.os }}-node@12-python@3.6-
            ${{ runner.os }}-node@12-
            ${{ runner.os }}-
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Full Build
        run: yarn build
      - name: List Output Files
        id: list-output-files
        run: |-
          output=$(
            git status --ignored --untracked-files --porcelain \
            | grep -v node_modules \
            | cut -c 4-
            | sed -e 's#^#${{ github.workspace }}/#'
          )
          # Need to escape % and CR/LF before setting output (it's de-manged in GH engine)
          output="${output//'%'/'%25'}"
          output="${output//$'\n'/'%0A'}"
          output="${output//$'\r'/'%0D'}"
          echo "::set-output name=files::${output}"
      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: build-output
          path: |-
            ${{ steps.list-output-files.outputs.files }}
            !**/node_modules/**

  test:
    name: Test (${{ matrix.os }} / java ${{ matrix.java }} / node ${{ matrix.node }} / python ${{ matrix.python }})
    needs: build
    strategy:
      fail-fast: false
      matrix:
        # All currently supported node versions (Maintenance LTS, Active LTS, Current)
        dotnet: ['3.1.x']
        java: ['8']
        node: ['10', '12', '13', '14']
        os: [ubuntu-latest, windows-latest, macos-latest]
        python: ['3.6']
        # Add specific runs for different variations of java/python only against node 10 / ubuntu-latest
        include:
          - dotnet: '3.1.x'
            java: '11'
            node: '10'
            os: ubuntu-latest
            python: '3.8'
          - dotnet: '3.1.x'
            java: '11'
            node: '10'
            os: ubuntu-latest
            python: '3.7'
          - dotnet: '3.1.x'
            java: '11'
            node: '10'
            os: ubuntu-latest
            python: '3.8'
          - dotnet: '3.1.x'
            java: '8'
            node: '10'
            os: ubuntu-latest
            python: '3.8'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Set up .NET ${{ matrix.dotnet }}
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ matrix.dotnet }}
      - name: Set up Java ${{ matrix.java }}
        uses: actions/setup-java@v1
        with:
          java-version: ${{ matrix.java }}
      - name: Set up Node ${{ matrix.node }}
        uses: actions/setup-node@v2.1.1
        with:
          node-version: ${{ matrix.node }}
      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-node@v2.1.1
        with:
          python-version: ${{ matrix.python }}
      - name: Install python3-venv
        if: runner.os == 'Linux'
        run: sudo apt install -y python3-venv
      - name: Check out
        uses: actions/checkout@v2
      - name: Download Artifact
        uses: actions/download-artifact@v2
        with:
          name: build-output
      - name: Locate Caches
        id: cache-locations
        run: |-
          # Need to have PIP >= 20.1 for "pip cache dir" to work
          python -m pip install --upgrade pip
          echo "::set-output name=pip-cache::$(pip cache dir)"
          echo "::set-output name=yarn-cache::$(yarn cache dir)"
      - name: Cache
        uses: actions/cache@v2
        with:
          path: |-
            ${{ steps.cache-locations.outputs.pip-cache }}
            ${{ steps.cache-locations.outputs.yarn-cache }}
            ~/.m2/repository
            ~/.nuget/packages
          # Not including .NET / Java in the cache keys, those artifacts are SDK-version-independent
          key: ${{ runner.os }}-node@${{ matrix.node }}-python@${{ matrix.python }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |-
            ${{ runner.os }}-node@${{ matrix.node }}-python@${{ matrix.python }}-
            ${{ runner.os }}-node@${{ matrix.node }}-
            ${{ runner.os }}-
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Test
        run: yarn test
